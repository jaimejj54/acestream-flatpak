id: org.Acestream.engine
runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
command: acestream.engine
finish-args:
  - --socket=x11
  - --socket=wayland
  - --share=ipc
  - --share=network
  - --filesystem=home/.ACEStream
  - --talk-name=org.kde.StatusNotifierWatcher
modules:
  - python3-requirements.json

  - name: appindicator-icon-shim
    buildsystem: simple
    build-commands:
      - cc -shared -fPIC appindicator_icon_override.c -o libappindicator_icon_override.so -ldl
      - install -Dm755 libappindicator_icon_override.so /app/lib/libappindicator_icon_override.so
    sources:
      - type: file
        path: appindicator_icon_override.c

  - name: acestream.engine
    buildsystem: simple
    build-commands:
      - install -Dm755 start_engine.sh /app/bin/acestream.engine
      - mkdir /app/bin/acestream/
      - cp * -r /app/bin/acestream/
      - chmod +w -R /app/bin/acestream/ 
    sources:
      - type: script
        dest-filename: start_engine.sh
        commands:
          - cd /app/bin/acestream
          - export LD_PRELOAD=/app/lib/libappindicator_icon_override.so
          - ./start-engine --client-gtk --log-stdout --log-file /dev/null
      - type: dir
        path: acestream
    
  - name: tray-icon
    buildsystem: simple
    build-commands:
      - mkdir -p /app/share/icons/hicolor/symbolic/apps/
      - cp acestream16.png /app/share/icons/hicolor/symbolic/apps/org.Acestream.engine-symbolic.png
    sources:
      - type: file
        path: acestream/data/images/acestream16.png
  
  - name: icons
    buildsystem: simple
    build-commands:
      - mkdir -p /app/share/icons/
      - cp * -r /app/share/icons/
    sources:
      - type: dir
        path: icons

  - name: desktop
    buildsystem: simple
    build-commands:
      - mkdir -p /app/share/applications/
      - cp org.Acestream.engine.desktop /app/share/applications/
    sources:
      - type: file
        path: org.Acestream.engine.desktop
  
  - shared-modules/libappindicator/libappindicator-gtk3-introspection-12.10.json
  
build-options:
  build-args: 
    --share=network
  env:
    FLATPAK_ENABLE_NETWORK: 'yes'